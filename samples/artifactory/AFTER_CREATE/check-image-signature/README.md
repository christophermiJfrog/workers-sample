# Check Image Signature

This worker demonstrates a signature validation scenario. After a Docker image has been uploaded, the worker verifies if the image is signed by checking for the presence of a signature file (e.g., `.sig` file generated by cosign). If the image is not signed, the worker removes it.

## Worker Functionality

### Workflow Overview
1. **Intercept the Creation of a Docker Image:**
   - The worker identifies Docker manifests by checking if the uploaded file ends with `manifest.json`.

2. **Verify the Signature:**
   - The worker checks if a signature file corresponding to the manifest exists.
   - If the image is unsigned, it removes the image from the repository.

3. **Remove Unsigned Images:**
   - If the image is unsigned, the worker deletes it from the repository.
   - If only one version of the image exists, the entire image is removed.
   - Otherwise, only the unsigned version is deleted.

## Responses

### Response Types

- **Signed Image:**
  ```json
  {
    "message": "proceed"
  }
  ```

- **Unsigned Image:**
  ```json
  {
    "message": "Removing unsigned image test-docker-repo:your-image-name/1.0/manifest.json"
  }
  ```

- **Error During Signature Check:**
  ```json
  {
    "message": "Unexpected error: Cannot read properties of undefined (reading 'sha256')"
  }
  ```

- **Error While Checking Signature:**
  ```json
  {
    "message": "Error while checking signature: Error message"
  }
  ```


### Key Methods

- **`isDockerManifest(data)`**
  - Identifies Docker manifests by checking if the file ends with `manifest.json`.

- **`isSigned(context, data)`**
  - Verifies if the image is signed by checking for the presence of a signature file for the manifest.

- **`deleteImage(context, data)`**
  - Removes the image from the repository if it is unsigned.

- **`findDeployedVersions(context, repoKey, repoName, limit)`**
  - Finds versions of the image deployed in the repository.

- **`extractRepoInfos(data)`**
  - Extracts repository information such as repository key, repository name, and version from the uploaded data.

- **`getImageSha256(context, data)`**
  - Retrieves the SHA-256 checksum of the Docker manifest.

- **`runAql(context, query)`**
  - Runs an AQL (Artifactory Query Language) query to fetch details about artifacts.

- **`deleteArtifact(context, repoKey, repoName)`**
  - Deletes the specified artifact from the repository.

## Use Case

This worker ensures that only signed Docker images are stored in the repository, enhancing the security and integrity of the artifacts.

## Notes

- The worker assumes that the signature file is located in the `_uploads` directory and follows the naming convention `sha256-{manifestSha}.sig`.
- The worker uses AQL queries to identify existing versions and decide whether to delete the entire image or specific versions.
- Logs are added for troubleshooting and monitoring purposes.
